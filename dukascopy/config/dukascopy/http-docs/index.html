<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>OHLC Dashboard - Pagination</title>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <style>
        body { font-family: sans-serif; background: #f4f4f9; padding: 20px; }
        #chart { background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 10px; }
        .controls { 
            margin-bottom: 20px; 
            display: flex; 
            gap: 10px; 
            align-items: center; 
            background: #fff; 
            padding: 15px; 
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        select, button { padding: 8px; border-radius: 4px; border: 1px solid #ccc; cursor: pointer; }
        button:hover { background-color: #e0e0e0; }
        .nav-btn { font-weight: bold; min-width: 40px; background: #007bff; color: white; border: none; }
        .nav-btn:hover { background: #0056b3; }
        label { font-weight: bold; }
    </style>
</head>
<body>

    <h2>Interactive OHLC Stream</h2>
    
    <div class="controls">
        <label for="symbolSelect">Symbol:</label>
        <select id="symbolSelect" onchange="updateTimeframeOptions(); resetAndLoad();"></select>

        <label for="tfSelect">Timeframe:</label>
        <select id="tfSelect" onchange="resetAndLoad()"></select>

        <button class="nav-btn" onclick="paginate(-1)"> < </button>
        <button onclick="resetAndLoad()">Today</button>
        <button class="nav-btn" onclick="paginate(1)"> > </button>
    </div>
    
    <div id="chart"></div>

    <script>
        let symbolData = {}; 
        let currentAfterDate = new Date(); // Tracks our current view position

        const options = {
            series: [],
            chart: {
                type: 'candlestick',
                height: 600,
                id: 'ohlc-chart',
                animations: { enabled: false }
            },
            title: { text: 'Select a symbol to begin', align: 'left' },
            xaxis: { 
                type: 'category',
                tickAmount: 10,
                labels: { rotate: -45 }
            },
            yaxis: { tooltip: { enabled: true } }
        };

        const chart = new ApexCharts(document.querySelector("#chart"), options);
        chart.render();

        window.__callbackList = function(response) {
            if (response.status === "ok") {
                symbolData = response.result;
                const symbolSelect = document.getElementById('symbolSelect');
                Object.keys(symbolData).sort().forEach(symbol => {
                    const opt = document.createElement('option');
                    opt.value = symbol;
                    opt.innerHTML = symbol;
                    symbolSelect.appendChild(opt);
                });
                symbolSelect.value = "EUR-USD";
                updateTimeframeOptions();
                resetAndLoad();
            }
        };

        function updateTimeframeOptions() {
            const symbol = document.getElementById('symbolSelect').value;
            const tfSelect = document.getElementById('tfSelect');
            tfSelect.innerHTML = ""; 
            if (symbolData[symbol]) {
                symbolData[symbol].forEach(tf => {
                    const opt = document.createElement('option');
                    opt.value = tf;
                    opt.innerHTML = tf;
                    tfSelect.appendChild(opt);
                });
                if (symbolData[symbol].includes("1h")) tfSelect.value = "1h";
            }
        }

        window.__callbackData = function(response) {
            const grouped = {};
            response.result.forEach(row => {
                if (!grouped[row.symbol]) grouped[row.symbol] = [];
                grouped[row.symbol].push({
                    x: row.time, 
                    y: [row.open, row.high, row.low, row.close]
                });
            });

            const seriesData = Object.keys(grouped).map(symbol => ({
                name: symbol,
                data: grouped[symbol]
            }));

            const sym = document.getElementById('symbolSelect').value;
            const tf = document.getElementById('tfSelect').value;
            
            chart.updateOptions({
                title: { text: `${sym} (${tf}) - Starting: ${currentAfterDate.toLocaleString()}` }
            });
            chart.updateSeries(seriesData);
        };

        function fetchJSONP(url) {
            const oldScript = document.getElementById('jsonp-script');
            if (oldScript) oldScript.remove();
            const script = document.createElement('script');
            script.id = 'jsonp-script';
            script.src = url;
            document.body.appendChild(script);
        }

        // Helper to get jump size in milliseconds based on TF
        function getTimeframeOffset(tf) {
            switch (tf) {
                case '1M':  return 10 * 365 * 24 * 60 * 60 * 1000; // 10 Years
                case '1Y':  return 50 * 365 * 24 * 60 * 60 * 1000; // Large jump for All Time
                case '1d':  return 180 * 24 * 60 * 60 * 1000;      // 6 Months
                case '1W':  return 365 * 24 * 60 * 60 * 1000;      // 1 Year
                case '4h':  return 14 * 24 * 60 * 60 * 1000;       // 2 Weeks
                case '1h':  return 7 * 24 * 60 * 60 * 1000;        // 1 Week
                case '30m': return 3 * 24 * 60 * 60 * 1000;        // 3 Days
                case '15m': return 1 * 24 * 60 * 60 * 1000;        // 1 Day
                case '5m':  return 12 * 60 * 60 * 1000;            // 12 Hours
                default:    return 1 * 60 * 60 * 1000;             // 1 Hour
            }
        }

        // Reset to "Now" and load
        function resetAndLoad() {
            const tf = document.getElementById('tfSelect').value;
            const offset = getTimeframeOffset(tf);
            currentAfterDate = new Date(Date.now() - offset);
            loadData();
        }

        // Paginates forward or backward
        function paginate(direction) {
            const tf = document.getElementById('tfSelect').value;
            const offset = getTimeframeOffset(tf);
            
            // Adjust the current global date by the offset
            const newTime = currentAfterDate.getTime() + (direction * offset);
            currentAfterDate = new Date(newTime);
            
            loadData();
        }

        function loadData() {
            const symbol = document.getElementById('symbolSelect').value;
            const tf = document.getElementById('tfSelect').value;
            
            // Format date for API
            const afterStr = currentAfterDate.toISOString().replace('T', ' ').slice(0, 19);

            const url = `http://localhost:8000/ohlcv/1.0/select/${symbol},${tf}/after/${encodeURIComponent(afterStr)}/output/JSONP?order=asc&limit=999&callback=__callbackData`;
            
            fetchJSONP(url);
        }

        function init() {
            fetchJSONP("http://localhost:8000/ohlcv/1.0/list/output/JSONP?callback=__callbackList");
        }

        init();
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>OHLC Dashboard - DuckDB API</title>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <style>
        body { font-family: sans-serif; background: #f4f4f9; padding: 20px; }
        #chart { background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 10px; }
        .controls { 
            margin-bottom: 20px; 
            display: flex; 
            gap: 10px; 
            align-items: center; 
            background: #fff; 
            padding: 15px; 
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        select, button { padding: 8px; border-radius: 4px; border: 1px solid #ccc; }
        label { font-weight: bold; }
    </style>
</head>
<body>

    <h2>Interactive OHLC Stream</h2>
    
    <div class="controls">
        <label for="symbolSelect">Symbol:</label>
        <select id="symbolSelect" onchange="updateTimeframeOptions()"></select>

        <label for="tfSelect">Timeframe:</label>
        <select id="tfSelect"></select>

        <button onclick="loadData()">Refresh Data</button>
    </div>
    
    <div id="chart"></div>

    <script>
        let symbolData = {}; // Global store for the list response

        const options = {
            series: [],
            chart: {
                type: 'candlestick',
                height: 600,
                id: 'ohlc-chart',
                animations: { enabled: false }
            },
            title: { text: 'Select a symbol to begin', align: 'left' },
            xaxis: { 
                type: 'category',
                tickAmount: 10,
                labels: { rotate: -45 }
            },
            yaxis: { tooltip: { enabled: true } }
        };

        const chart = new ApexCharts(document.querySelector("#chart"), options);
        chart.render();

        // 1. Callback for the INITIAL LIST of symbols
        window.__callbackList = function(response) {
            if (response.status === "ok") {
                symbolData = response.result;
                const symbolSelect = document.getElementById('symbolSelect');
                
                // Populate Symbol Dropdown
                Object.keys(symbolData).sort().forEach(symbol => {
                    const opt = document.createElement('option');
                    opt.value = symbol;
                    opt.innerHTML = symbol;
                    symbolSelect.appendChild(opt);
                });

                // Default selection
                symbolSelect.value = "EUR-USD";
                updateTimeframeOptions();
                loadData();
            }
        };

        // Update timeframes based on selected symbol
        function updateTimeframeOptions() {
            const symbol = document.getElementById('symbolSelect').value;
            const tfSelect = document.getElementById('tfSelect');
            tfSelect.innerHTML = ""; // Clear existing

            if (symbolData[symbol]) {
                symbolData[symbol].forEach(tf => {
                    const opt = document.createElement('option');
                    opt.value = tf;
                    opt.innerHTML = tf;
                    tfSelect.appendChild(opt);
                });
                // Set default TF to 1h if available
                if (symbolData[symbol].includes("1h")) tfSelect.value = "1h";
            }
        }

        // 2. Callback for the ACTUAL CHART DATA
        window.__callbackData = function(response) {
            const grouped = {};
            response.result.forEach(row => {
                if (!grouped[row.symbol]) grouped[row.symbol] = [];
                grouped[row.symbol].push({
                    x: row.time, 
                    y: [row.open, row.high, row.low, row.close]
                });
            });

            const seriesData = Object.keys(grouped).map(symbol => ({
                name: symbol,
                data: grouped[symbol]
            }));

            const sym = document.getElementById('symbolSelect').value;
            const tf = document.getElementById('tfSelect').value;
            
            chart.updateOptions({
                title: { text: `${sym} (${tf}) - Last 7 days` }
            });
            chart.updateSeries(seriesData);
        };

        // 3. Helper to fetch data
        function fetchJSONP(url) {
            const oldScript = document.getElementById('jsonp-script');
            if (oldScript) oldScript.remove();
            
            const script = document.createElement('script');
            script.id = 'jsonp-script';
            script.src = url;
            document.body.appendChild(script);
        }

        function loadData() {
            const symbol = document.getElementById('symbolSelect').value;
            const tf = document.getElementById('tfSelect').value;
            let afterDate;

            switch (tf) {
                case '1M':
                    const tenYearsAgo = new Date();
                    tenYearsAgo.setFullYear(tenYearsAgo.getFullYear() - 10);
                    afterDate = tenYearsAgo.toISOString().replace('T', ' ').slice(0, 19);
                    break;
                case '1Y':
                    afterDate = "1970-01-01 00:00:00";
                    break;
                case '1d':
                    const halfYearAgo = new Date();
                    halfYearAgo.setMonth(halfYearAgo.getMonth() - 6);
                    afterDate = halfYearAgo.toISOString().replace('T', ' ').slice(0, 19);
                    break;                
                case '1W':
                    const yearAgo = new Date();
                    yearAgo.setFullYear(yearAgo.getFullYear() - 1);
                    afterDate = yearAgo.toISOString().replace('T', ' ').slice(0, 19);
                    break;
                case '4h':
                    const fourWeekAgo = new Date(Date.now() - 28 * 24 * 60 * 60 * 1000);
                    afterDate = fourWeekAgo.toISOString().replace('T', ' ').slice(0, 19);
                    break;
                case '1h':
                    const twoWeekAgo = new Date(Date.now() - 14 * 24 * 60 * 60 * 1000);
                    afterDate = twoWeekAgo.toISOString().replace('T', ' ').slice(0, 19);
                    break;
                default:
                    const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
                    afterDate = weekAgo.toISOString().replace('T', ' ').slice(0, 19);
                    break;
            }

            const url = `http://localhost:8000/ohlcv/1.0/select/${symbol},${tf}/after/${encodeURIComponent(afterDate)}/output/JSONP?order=asc&limit=999&callback=__callbackData`;
            
            fetchJSONP(url);
        }

        function init() {
            fetchJSONP("http://localhost:8000/ohlcv/1.0/list/output/JSONP?callback=__callbackList");
        }

        init();
    </script>
</body>
</html>
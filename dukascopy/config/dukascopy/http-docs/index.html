<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>OHLC Dashboard - DuckDB API</title>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <style>
        body { font-family: sans-serif; background: #f4f4f9; padding: 20px; }
        #chart { background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 10px; }
        .controls { margin-bottom: 20px; }
    </style>
</head>
<body>

    <h2>Live OHLC Stream - EUR-USD example</h2>
    <div class="controls">
        <button onclick="loadData()">Refresh Data</button>
    </div>
    
    <div id="chart"></div>

    <script>
        const options = {
            series: [],
            chart: {
                type: 'candlestick',
                height: 600,
                id: 'ohlc-chart'
            },
            title: { text: 'EUR-USD (1h) - Last 7 days', align: 'left' },
            xaxis: { 
                    type: 'category',
                    tickAmount: 10, // Force only 10 labels to show
                    labels: {
                        rotate: -45
                    }
            },
            yaxis: { tooltip: { enabled: true } }
        };

        const chart = new ApexCharts(document.querySelector("#chart"), options);
        chart.render();

        window.__callback2131 = function(response) {
            const grouped = {};
            response.result.forEach(row => {
                if (!grouped[row.symbol]) grouped[row.symbol] = [];
                
                grouped[row.symbol].push({
                    x: row.time, 
                    y: [row.open, row.high, row.low, row.close]
                });
            });

            const seriesData = Object.keys(grouped).map(symbol => ({
                name: symbol,
                data: grouped[symbol]
            }));

            chart.updateSeries(seriesData);
        };

        const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)
            .toISOString()
            .replace('T', ' ')
            .slice(0, 19);

        function loadData() {
            const baseUrl = "http://localhost:8000/ohlcv/1.0/select/EUR-USD,1h/after/"+weekAgo+"/output/JSONP";
            const params = "?order=asc&limit=999&offset=0&callback=__callback2131";
            
            const script = document.createElement('script');
            script.id = 'jsonp-request';
            script.src = baseUrl + params;
            document.body.appendChild(script);
        }

        // Initial load
        loadData();
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Trading API - Query Builder v1.1</title>
    <style>
        :root {
            --bg-main: #f0f3fa; --sidebar-dark: #131722; --accent-blue: #2962ff;
            --text-gray: #787b86; --white: #ffffff; --border-color: #e0e3eb; --danger-red: #f23645;
        }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg-main); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* Sidebars */
        .sidebar { width: 380px; background: var(--white); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; flex-shrink: 0; }
        .info-panel { width: 300px; background: var(--white); border-left: 1px solid var(--border-color); display: flex; flex-direction: column; flex-shrink: 0; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        
        header { background: var(--sidebar-dark); color: white; padding: 15px 20px; }
        header h2 { margin: 0; font-size: 16px; font-weight: 500; }
        .sidebar-content { padding: 20px; overflow-y: auto; flex-grow: 1; }
        
        /* Info Panel Typography */
        .info-header { font-size: 14px; font-weight: 700; color: var(--sidebar-dark); margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; text-transform: uppercase; }
        .info-label { font-size: 11px; color: var(--text-gray); font-weight: 700; text-transform: uppercase; margin-top: 15px; margin-bottom: 5px; }
        .info-value { font-size: 13px; color: #131722; line-height: 1.4; }
        .meta-tag { display: inline-block; background: #f0f3fa; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-right: 5px; margin-bottom: 5px; border: 1px solid var(--border-color); }

        /* Controls */
        .control-group { margin-bottom: 20px; }
        label { display: block; font-size: 11px; color: var(--text-gray); text-transform: uppercase; font-weight: 700; margin-bottom: 8px; }
        select, input { width: 100%; padding: 8px 10px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 13px; box-sizing: border-box; }
        .mode-selector { display: flex; background: #f1f3f7; padding: 4px; border-radius: 6px; margin-bottom: 20px; }
        .mode-btn { flex: 1; padding: 8px; text-align: center; font-size: 11px; font-weight: 600; cursor: pointer; border-radius: 4px; color: var(--text-gray); }
        .mode-btn.active { background: var(--white); color: var(--accent-blue); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .param-box { background: #f8f9fd; padding: 12px; border-radius: 6px; border: 1px dashed var(--border-color); margin-top: 10px; }
        .indicator-tag { background: #e3e9ff; color: var(--accent-blue); padding: 5px 10px; border-radius: 15px; font-size: 11px; font-weight: 600; display: flex; align-items: center; justify-content: space-between; margin-bottom: 5px; }
        .add-btn { background: #f0f3fa; border: 1px solid var(--accent-blue); color: var(--accent-blue); padding: 8px; border-radius: 4px; font-size: 11px; font-weight: 700; cursor: pointer; margin-top: 10px; width: 100%; }
        .checkbox-group { display: flex; gap: 15px; margin-top: 10px; }
        .checkbox-item { display: flex; align-items: center; font-size: 12px; color: var(--sidebar-dark); cursor: pointer; }
        .checkbox-item input { width: auto; margin-right: 6px; }
        
        .sidebar-footer { padding: 15px 20px; border-top: 1px solid var(--border-color); background: #fafbfc; text-align: center; }
        .attribution { font-size: 11px; color: var(--text-gray); text-decoration: none; }
        .attribution strong { color: #5d606b; }

        .main-view { flex-grow: 1; padding: 40px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .preview-card { background: var(--white); width: 100%; max-width: 900px; padding: 30px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border: 1px solid var(--border-color); }
        .url-display { background: #1e222d; color: #d1d4dc; padding: 15px; border-radius: 4px; font-family: monospace; font-size: 12px; word-break: break-all; margin: 20px 0; border-left: 4px solid var(--accent-blue); min-height: 40px; }
        .download-btn { width: 100%; padding: 12px; background: var(--accent-blue); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 600; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="sidebar">
        <header><h2>Data Query Builder</h2></header>
        <div class="sidebar-content">
            <label>Mode</label>
            <div class="mode-selector">
                <div id="mode-price" class="mode-btn active" onclick="setMode('price')">Price</div>
                <div id="mode-indicator" class="mode-btn" onclick="setMode('indicator')">Indicator</div>
                <div id="mode-combined" class="mode-btn" onclick="setMode('combined')">Combined</div>
            </div>

            <div class="control-group">
                <label>Symbol & Timeframe</label>
                <div style="display:flex; gap:5px">
                    <select id="symbolSelect" onchange="updateTFs()"></select>
                    <select id="tfSelect" onchange="updateUrl()"></select>
                </div>
                <div class="checkbox-group">
                    <label class="checkbox-item"><input type="checkbox" id="skipLast" onchange="updateUrl()"> :skiplast</label>
                    <label class="checkbox-item"><input type="checkbox" id="mt4Mode" onchange="updateUrl()"> /MT4 CSV</label>
                </div>
            </div>

            <div id="ind-group" class="control-group hidden">
                <label>Indicator Plugin</label>
                <select id="indicatorSelect" onchange="renderParams()"></select>
                <div id="params" class="param-box"></div>
                <button id="addBtn" class="add-btn hidden" onclick="addToChain()">+ Add to Chain</button>
            </div>

            <div id="chain-group" class="control-group hidden"><label>Indicator Chain</label><div id="chain-list"></div></div>

            <div class="control-group">
                <label>Date Range</label>
                <input type="text" id="after" value="2026-01-01 00:00:00" oninput="updateUrl()">
                <input type="text" id="until" value="3000-01-01 00:00:00" oninput="updateUrl()" style="margin-top:5px">
            </div>

            <div class="control-group">
                <label>Limit & Order</label>
                <div style="display:flex; gap:5px">
                    <input type="number" id="limit" value="1440" oninput="updateUrl()">
                    <select id="order" onchange="updateUrl()"><option value="desc">DESC</option><option value="asc">ASC</option></select>
                </div>
            </div>
        </div>
        
        <div class="sidebar-footer">
            <a href="https://www.dukascopy.com" target="_blank" class="attribution">
                Market data by <strong>Dukascopy</strong>
            </a>
        </div>
    </div>

    <div class="main-view">
        <div class="preview-card">
            <label>Endpoint Preview</label>
            <div id="urlPreview" class="url-display">Fetching registries...</div>
            <button class="download-btn" onclick="execute()">Execute Request</button>
        </div>
    </div>

    <div id="infoPanel" class="info-panel hidden">
        <div id="infoTitle" class="info-header">Indicator Info</div>
        <div class="info-label">Description</div>
        <div id="infoDesc" class="info-value">Select an indicator to see details.</div>
        <div class="info-label">Warmup Rows</div>
        <div id="infoWarmup" class="info-value">0</div>
        <div class="info-label">Metadata</div>
        <div id="infoMeta" class="info-value"></div>
    </div>

    <script>
        let symbolData = {}; 
        let indicatorData = {}; 
        let chain = []; 
        let currentMode = 'price';

        const get = (id) => document.getElementById(id);

        window.__callbackList = (data) => {
            if (data.status === "ok") {
                symbolData = data.result;
                get('symbolSelect').innerHTML = Object.keys(symbolData).map(s => `<option value="${s}">${s}</option>`).join('');
                updateTFs();
            }
        };

        window.__bp_callback = (res) => {
            if (res.status === "ok") {
                indicatorData = res.result;
                get('indicatorSelect').innerHTML = Object.keys(indicatorData).map(i => `<option value="${i}">${i.toUpperCase()}</option>`).join('');
                renderParams();
            }
        };

        function updateTFs() {
            const sym = get('symbolSelect').value;
            if (symbolData[sym]) {
                get('tfSelect').innerHTML = symbolData[sym].map(tf => `<option value="${tf}">${tf}</option>`).join('');
                updateUrl();
            }
        }

        function renderParams() {
            const ind = get('indicatorSelect').value;
            const meta = indicatorData[ind];
            const container = get('params');

            // Update Info Panel visibility and content
            if (currentMode !== 'price' && meta) {
                get('infoPanel').classList.remove('hidden');
                get('infoTitle').innerText = meta.name.toUpperCase();
                get('infoDesc').innerText = meta.description || 'N/A';
                get('infoWarmup').innerText = meta.warmup || '0';
                get('infoMeta').innerHTML = meta.meta ? 
                    Object.entries(meta.meta).map(([k, v]) => `<div class="meta-tag">${k}: ${v}</div>`).join('') : 'None';
            } else {
                get('infoPanel').classList.add('hidden');
            }

            if (meta && meta.defaults) {
                container.innerHTML = Object.keys(meta.defaults).map(k => `
                    <div style="margin-bottom:8px">
                        <label style="font-size:9px; margin-bottom:2px">${k}</label>
                        <input type="text" id="p_${k}" value="${meta.defaults[k]}" oninput="updateUrl()">
                    </div>`).join('');
            } else {
                container.innerHTML = '<span style="color:#999; font-size:11px">No parameters</span>';
            }
            updateUrl();
        }

        function setMode(m) {
            currentMode = m;
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.toggle('active', b.id === `mode-${m}`));
            get('ind-group').classList.toggle('hidden', m === 'price');
            get('addBtn').classList.toggle('hidden', m !== 'combined');
            get('chain-group').classList.toggle('hidden', m !== 'combined');
            renderParams(); // Updates info panel visibility
            updateUrl();
        }

        function addToChain() {
            const name = get('indicatorSelect').value;
            const meta = indicatorData[name];
            const params = meta.defaults ? Object.keys(meta.defaults).map(k => get(`p_${k}`).value) : [];
            
            // DUPLICATE CHECK: Prevent exact same indicator + settings
            const isDuplicate = chain.some(item => 
                item.name === name && JSON.stringify(item.params) === JSON.stringify(params)
            );

            if (isDuplicate) {
                alert(`Error: This ${name.toUpperCase()} with these settings is already in the chain.`);
                return;
            }

            chain.push({ name, params });
            renderChain();
            updateUrl();
        }

        function renderChain() {
            get('chain-list').innerHTML = chain.map((item, i) => `
                <div class="indicator-tag">
                    <span>${item.name}(${item.params.join(',')})</span>
                    <span style="cursor:pointer" onclick="chain.splice(${i},1); renderChain(); updateUrl();">âœ•</span>
                </div>`).join('');
        }

        function buildUrl() {
            const sym = get('symbolSelect').value;
            const tfRaw = get('tfSelect').value;
            if (!sym || !tfRaw) return "Waiting for API data...";

            // Maintain exact modifier and format logic
            const tf = get('skipLast').checked ? `${tfRaw}:skiplast` : tfRaw;
            const outFormat = get('mt4Mode').checked ? 'CSV/MT4' : 'CSV';
            
            const after = encodeURIComponent(get('after').value);
            const until = encodeURIComponent(get('until').value);
            const common = `after/${after}/until/${until}/output/${outFormat}?limit=${get('limit').value}&order=${get('order').value}`;

            if (currentMode === 'price') {
                return `/ohlcv/1.0/select/${sym},${tf}/${common}`;
            }

            if (currentMode === 'indicator') {
                const ind = get('indicatorSelect').value;
                const meta = indicatorData[ind];
                let pPath = "";
                if (meta && meta.defaults) pPath = Object.keys(meta.defaults).map(k => `/${k}/${get(`p_${k}`).value}`).join('');
                return `/ohlcv/1.0/indicator/${ind}${pPath}/after/${after}/until/${until}/select/${sym},${tf}/output/${outFormat}?limit=${get('limit').value}&order=${get('order').value}`;
            }

            // Combined Mode v1.1 logic
            const chainStr = chain.length ? `[${chain.map(i => `${i.name}(${i.params.join(',')})`).join(':')}]` : "";
            return `/ohlcv/1.1/select/${sym},${tf}${chainStr}/${common}`;
        }

        function updateUrl() { get('urlPreview').innerText = buildUrl(); }
        function execute() { window.location.href = buildUrl(); }

        document.addEventListener('DOMContentLoaded', () => {
            const s1 = document.createElement('script');
            s1.src = "/ohlcv/1.0/list/output/JSONP?callback=__callbackList";
            document.body.appendChild(s1);
            const s2 = document.createElement('script');
            s2.src = "/ohlcv/1.1/list/indicators/output/JSONP?callback=__bp_callback";
            document.body.appendChild(s2);
        });
    </script>
</body>
</html>
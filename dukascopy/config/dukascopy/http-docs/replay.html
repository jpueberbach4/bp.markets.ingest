<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Terminal - Replay (fun demo)</title>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        :root {
            --bg-main: #f0f3fa; --sidebar-dark: #131722; --accent-blue: #2962ff;
            --text-gray: #787b86; --white: #ffffff; --border-color: #e0e3eb;
        }

        body { 
            font-family: -apple-system, system-ui, sans-serif; background: var(--bg-main); 
            margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden;
        }

        header {
            background: var(--sidebar-dark); color: white; padding: 10px 20px;
            display: flex; align-items: center; justify-content: space-between; height: 50px;
        }

        .main-container { display: flex; flex: 1; overflow: hidden; }

        .sidebar { 
            width: 300px; background: var(--white); border-right: 1px solid var(--border-color);
            display: flex; flex-direction: column; padding: 15px; overflow-y: auto;
        }

        .control-group { margin-bottom: 15px; }
        label { font-size: 11px; color: var(--text-gray); text-transform: uppercase; font-weight: 700; display: block; margin-bottom: 5px; }
        select, input { width: 100%; padding: 6px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 13px; box-sizing: border-box; }
        
        .param-box { background: #f8f9fd; padding: 10px; border-radius: 4px; border: 1px dashed var(--border-color); margin-top: 5px; }
        .indicator-tag { 
            background: #e3e9ff; color: var(--accent-blue); padding: 4px 8px; border-radius: 12px; 
            font-size: 11px; font-weight: 600; display: flex; align-items: center; justify-content: space-between; margin-bottom: 4px;
        }
        .add-btn { 
            background: var(--white); border: 1px solid var(--accent-blue); color: var(--accent-blue); 
            padding: 6px; border-radius: 4px; font-size: 11px; font-weight: 700; cursor: pointer; width: 100%; margin-top: 5px;
        }

        div[id^="tv-attr-logo"], 
        .tv-embed-widget-wrapper__attribution,
        #main-chart-container a[href*="tradingview.com"] {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            pointer-events: none !important;
        }

        #chart-legend {
            position: absolute;
            z-index: 1000;
            pointer-events: none;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            color: #131722;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            display: none;
            line-height: 1.4;
        }

        .legend-ohlcv { font-weight: bold; border-bottom: 1px solid #eee; margin-bottom: 6px; padding-bottom: 4px; }
        .legend-item { display: flex; justify-content: space-between; margin-bottom: 2px; gap: 15px; font-size: 11px; }

        #content-wrapper { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
        }

        #main-chart-container { 
            flex: 1 1 auto; 
            min-height: 0; 
            position: relative; 
        }

        #export-modal {
            display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); align-items: center; justify-content: center;
        }
        .modal-content {
            background: white; padding: 25px; border-radius: 8px; width: 320px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        .modal-content h3 { margin-top: 0; font-size: 16px; color: var(--sidebar-dark); }
        .export-field { margin-bottom: 15px; }
        .export-checkboxes { display: flex; gap: 15px; margin-bottom: 20px; font-size: 12px; }
        .cancel-btn { 
            background: #e0e3eb; color: #131722; border: none; padding: 10px; 
            border-radius: 4px; font-weight: 600; cursor: pointer; width: 48%; 
        }
        .exec-btn { 
            background: var(--accent-blue); color: white; border: none; padding: 10px; 
            border-radius: 4px; font-weight: 600; cursor: pointer; width: 48%; 
        }


        /* The Replay Toolbar (Hidden by default) */
        #replay-toolbar {
            display: none; align-items: center; gap: 10px; 
            background: #2a2e39; padding: 4px 12px; border-radius: 4px; border: 1px solid #434651;
            margin-left: 20px;
        }

        .replay-badge { 
            font-size: 10px; font-weight: 800; color: #ff9800; text-transform: uppercase; 
            letter-spacing: 1px; margin-right: 5px; 
        }

        .replay-btn {
            background: #363c4e; border: 1px solid #434651; color: #d1d4dc;
            padding: 4px 10px; border-radius: 3px; cursor: pointer; font-size: 12px; font-weight: 500;
            transition: all 0.2s;
        }
        .replay-btn:hover { background: #50566e; color: white; }
        .replay-btn.play { background: var(--success); color: white; border-color: var(--success); }
        .replay-btn.pause { background: var(--danger); color: white; border-color: var(--danger); }
        .replay-btn.exit { color: #ef5350; border-color: transparent; background: transparent; }
        .replay-btn.exit:hover { background: rgba(239, 83, 80, 0.1); }

        .speed-select {
            background: #131722; color: #d1d4dc; border: 1px solid #434651;
            border-radius: 3px; padding: 3px; font-size: 11px; outline: none;
        }

        .action-btn { 
            width: 100%; padding: 10px; border-radius: 4px; font-weight: 600; cursor: pointer; border: none; margin-top: 10px;
        }

        .btn-primary { background: var(--accent-blue); color: white; }
        .btn-secondary { background: #313339; color: white; }
        .btn-outline { background: var(--white); border: 1px solid var(--accent-blue); color: var(--accent-blue); padding: 6px; font-size: 11px; margin-top: 5px;}


        #panel-container { 
            flex: 0 0 auto; 
            display: flex; 
            flex-direction: column;
            background: #fcfcfc;
            overflow-y: auto;
            max-height: 60vh;
        }

        .indicator-panel { 
            position: relative;
            height: 130px; 
            flex-shrink: 0;
            border-top: 1px solid #444;
            background: white;
            transform: translateZ(0);
            backface-visibility: hidden;
            contain: strict;
        }

        .panel-title {
            position: absolute;
            top: 5px;
            left: 8px;
            z-index: 5;
            font-size: 11px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
            color: #131722;
            border: 1px solid #6e6f70;
            background: rgba(230, 228, 228, 0.7);
            padding: 2px 4px;
            border-radius: 2px;
            pointer-events: none;
            font-weight: 600;
            text-transform: uppercase;
            overflow-anchor: none;
        }

        /* UTILS */
        #loader {
            display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255, 255, 255, 0); z-index: 100; 
            justify-content: center; align-items: center; pointer-events: none; 
        }
        .spinner {
            width: 24px; height: 24px; border: 3px solid #f3f3f3;
            border-top: 3px solid var(--accent-blue); border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* MODALS */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 9999; align-items: center; justify-content: center;
        }
        .modal-box {
            background: var(--white); width: 340px; border-radius: 8px; overflow: hidden; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.3); animation: slideIn 0.2s ease-out;
        }
        @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .modal-header { background: var(--sidebar-dark); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; }
        .split-actions { display: flex; gap: 10px; margin-top: 20px; }
        .split-actions button { flex: 1; padding: 12px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; color: white; }

        body.dark-theme {
            --bg-main: #0b0e14;
            --white: #131722;
            --sidebar-dark: #0b0e14;
            --border-color: #2a2e39;
            --text-gray: #b2b5be;
            background-color: var(--bg-main);
        }

        body.dark-theme #panel-container {
            background-color: var(--bg-main);
        }

        body.dark-theme .indicator-panel {
            background-color: var(--white);
            border-top: 1px solid var(--border-color);
            margin-top: 0 !important; 
            padding-bottom: 2px;
        }

        body.dark-theme select, 
        body.dark-theme input {
            background-color: #1e222d !important;
            color: #d1d4dc !important;
            border: 1px solid #363c4e !important;
        }

        body.dark-theme .sidebar {
            background-color: #131722;
            border-right: 1px solid #2a2e39;
        }

        body.dark-theme .param-box { 
            background: #131722; 
            border: 1px dashed #363c4e; 
        }

        body.dark-theme .indicator-tag { 
            background: #2962ff22; 
            color: #2962ff; 
            border: 1px solid #2962ff44; 
        }

        body.dark-theme #chart-legend { 
            background: rgba(19, 23, 34, 0.85); 
            color: #d1d4dc; 
            border-color: #363c4e; 
            backdrop-filter: blur(4px);
        }

        body.dark-theme .panel-title { 
            background: #2a2e39; 
            color: #d1d4dc; 
            border: 1px solid #363c4e;
        }

        body.dark-theme .sidebar-footer {
            background-color: #131722 !important;
            border-top: 1px solid #2a2e39 !important;
            color: #d1d4dc !important;
        }

        body.dark-theme .sidebar-footer button {
            background-color: #1e222d !important;
            color: #d1d4dc !important;
            border: 1px solid #363c4e !important;
        }

        body.dark-theme .sidebar-footer button:hover {
            background-color: #2a2e39 !important;
            border-color: #2962ff !important;
        }

        body.dark-theme .sidebar-footer span,
        body.dark-theme .sidebar-footer label {
            color: #b2b5be !important;
        }

        body.dark-theme #calendarModal > div {
            background-color: #1e222d !important;
            color: #d1d4dc !important;
            border: 1px solid #363c4e !important;
            box-shadow: 0 16px 32px rgba(0,0,0,0.5) !important;
        }

        body.dark-theme #calendarModal h3 {
            color: #ffffff !important;
        }

        body.dark-theme #calendarInput {
            background-color: #131722 !important;
            border: 1px solid #363c4e !important;
            color: #ffffff !important;
            padding: 10px !important;
            border-radius: 4px !important;
            color-scheme: dark !important; 
        }

        body.dark-theme #calendarOk {
            background-color: #2962ff !important;
            color: #ffffff !important;
        }

        body.dark-theme #calendarOk:hover {
            background-color: #1e4bd8 !important;
        }

        body.dark-theme #closeModal {
            color: #b2b5be !important;
        }

        body.dark-theme #export-modal > .modal-content {
            background-color: #1e222d !important;
            color: #d1d4dc !important;
            border: 1px solid #363c4e !important;
            box-shadow: 0 16px 32px rgba(0,0,0,0.5) !important;
        }

        body.dark-theme #export-modal h3 {
            color: #ffffff !important;
        }

        body.dark-theme #export-modal input,
        body.dark-theme #export-modal select {
            background-color: #131722 !important;
            border: 1px solid #363c4e !important;
            color: #ffffff !important;
        }

        body.dark-theme #export-modal .exec-btn {
            background-color: #2962ff !important;
            color: #ffffff !important;
        }

        body.dark-theme #export-modal .cancel-btn {
            background-color: #363c4e !important;
            color: #d1d4dc !important;
        }       

    </style>
</head>
<body>
    <header>
        <div style="display:flex; align-items:center;">
            <h2 class="header-title">TERMINAL</h2>
            
            <div id="replay-toolbar">
                <span class="replay-badge">REPLAY</span>
                <button id="btn-play-pause" class="replay-btn play" onclick="togglePlayback()">‚ñ∂ Play</button>
                <select id="replaySpeed" class="speed-select" onchange="changeReplaySpeed()">
                    <option value="2000">0.5x</option>
                    <option value="1000" selected>1x</option>
                    <option value="500">2x</option>
                    <option value="100">10x</option>
                    <option value="50">25x</option>
                    <option value="25">50x</option>
                </select>
                <div style="width: 1px; height: 16px; background: #434651; margin: 0 5px;"></div>
                <button class="replay-btn exit" onclick="exitReplayMode(true)">‚úï Exit</button>
            </div>
        </div>

        <div style="display:flex; gap: 10px;">
            <button onclick="openCalendarModal()" style="background: var(--accent-blue); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-weight: 500;">üìÖ Jump / Replay</button>
            <button id="themeToggle" style="background: #313339; color: white; border: 1px solid #444; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-weight: 500;">üåô Dark Mode</button>
        </div>
    </header>

    <div class="main-container">
        <div class="sidebar">
            <div class="control-group">
                <label>Symbol</label>
                <select id="symbolSelect" onchange="updateTimeframeOptions(); resetAndLoad(true);"></select>
            </div>
            <div class="control-group">
                <label>Interval</label>
                <select id="tfSelect" onchange="resetAndLoad(true)"></select>
            </div>

            <hr style="border:0; border-top:1px solid var(--border-color); margin: 15px 0;">

            <div class="control-group">
                <label>Add Indicator</label>
                <select id="indicatorSelect" onchange="renderParams()"></select>
                <div id="params" class="param-box"></div>
                <button class="action-btn btn-outline" onclick="addToChain()">+ Add to Chart</button>
            </div>

            <div class="control-group">
                <label>Active Chain</label>
                <div id="chain-list"></div>
            </div>

            <div style="margin-top: auto;">
                <button onclick="resetAndLoad(false)" class="action-btn btn-primary">Refresh View</button>
                <button onclick="openExportModal()" class="action-btn btn-secondary">Export Data</button>
            </div>
        </div>

        <div id="content-wrapper">
            <div id="loader"><div class="spinner"></div></div>
            <div id="chart-legend"></div>
            <div id="main-chart-container"></div>
            <div id="panel-container"></div>
        </div>
    </div>

    <div id="calendarModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <h3 style="margin:0; font-size:14px;">NAVIGATE HISTORY</h3>
                <span onclick="closeModal('calendarModal')" style="cursor:pointer; font-size:18px;">&times;</span>
            </div>
            <div class="modal-body">
                <label>Select Date</label>
                <input type="date" id="calendarInput" style="width:100%; padding:10px; margin-bottom:10px;">
                
                <div class="split-actions">
                    <button onclick="handleDateAction('jump')" style="background: var(--accent-blue);">GO TO DATE</button>
                    <button onclick="handleDateAction('replay')" style="background: var(--accent-blue);">START REPLAY</button>
                </div>
                <p style="font-size:11px; color:var(--text-gray); margin-top:10px; text-align:center;">
                    "Go to Date" scrolls the chart.<br>"Start Replay" begins playback simulation.
                </p>
            </div>
        </div>
    </div>

    <div id="export-modal">
        <div class="modal-content">
            <h3>Export Settings</h3>
            <div class="export-field">
                <label>Start Date (After)</label>
                <input type="text" id="export-after" placeholder="YYYY-MM-DD HH:MM:SS">
            </div>
            <div class="export-field">
                <label>Total Records (Limit, max. 100000)</label>
                <input type="number" id="export-limit" value="1000">
            </div>
            <div class="export-field">
                <label>Order</label>
                <select id="export-order">
                    <option value="asc">Ascending</option>
                    <option value="desc">Descending</option>
                </select>
            </div>
            <div class="export-checkboxes">
                <label><input type="checkbox" id="export-mt4"> MT4 CSV</label>
                <label><input type="checkbox" id="export-skiplast"> SkipLast</label>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <button class="cancel-btn" onclick="document.getElementById('export-modal').style.display='none'">Cancel</button>
                <button class="exec-btn" onclick="runExport()">Download</button>
            </div>
        </div>
    </div>

<script>
    let isDark = false;
    let symbolData = {}; 
    let indicatorMeta = {};
    let chain = []; 
    let masterData = []; 
    
    let isFetching = false;
    let requestDirection = null;
    
    let isReplaying = false;
    let replayFutureBuffer = []; 
    let replayTimer = null;
    let replaySpeed = 1000;

    let mainChart, candleSeries, volumeSeries;
    let overlaySeriesMap = {}; 
    let panelCharts = {};      
    const rightPriceScaleWidth = 90;

    let bufferLimit = 3000; 
    let hasMoreHistory = true;


    function clearOnUpdate() {
        masterData = [];
        candleSeries.setData([]);
        volumeSeries.setData([]);
        Object.values(overlaySeriesMap).forEach(s => mainChart.removeSeries(s));
        overlaySeriesMap = {};
        Object.values(panelCharts).forEach(p => p.chart.remove());
        panelCharts = {};
        document.getElementById('panel-container').innerHTML = '';
        candleSeries.priceScale().applyOptions({
            autoScale: true,
        });
    }

    function resetAndLoad(clear = false) {
        // Refresh the indicator list from the API
        const s = document.createElement('script');
        s.src = "/ohlcv/1.1/list/indicators/output/JSONP?callback=__bp_callback";
        document.body.appendChild(s);
        if (clear) {
            clearOnUpdate();
        } else{

            const timeScale = mainChart.timeScale();
            const range = timeScale.getVisibleLogicalRange();
            
            if (range && masterData.length > 0) {
                const firstVisibleIdx = Math.max(0, Math.floor(range.from));
                
                // Save the anchor-time to force the view to remain unchanged
                // See: additional logic in __callbackData
                window.anchorTime = masterData[firstVisibleIdx].time;               
                window.savedWidth = range.to - range.from;

                masterData = [];
                candleSeries.setData([]);
                volumeSeries.setData([]);

                hasMoreHistory = true;
                gapRetryCount = 0;
                // We go FORWARD direction since the reference time is the left bar!
                requestDirection = 'forward';
                // Do not forget that we are dealing with epoch_ms, so multiply by 1000
                loadData('forward', window.anchorTime*1000);

                return;
            }
        }
        hasMoreHistory = true;
        gapRetryCount = 0;
        loadData('initial');
    }

    function initCharts() {
        const container = document.getElementById('main-chart-container');
        mainChart = LightweightCharts.createChart(container, {
            width: container.clientWidth, height: container.clientHeight,
            localization: { timeFormatter: (ts) => formatUnixToLiteral(ts) },
            layout: { background: { color: '#ffffff' }, textColor: '#131722', attributionLogo: false },
            timeScale: { 
                timeVisible: true, borderColor: '#e0e3eb', 
                shiftVisibleRangeOnNewBar: false
            },
            rightPriceScale: { borderVisible: false, minimumWidth: rightPriceScaleWidth },
        });

        new ResizeObserver(entries => {
            if (entries.length === 0 || !entries[0].contentRect) return;
            const { width, height } = entries[0].contentRect;
            mainChart.applyOptions({ width, height });
            Object.values(panelCharts).forEach(p => p.chart.applyOptions({ width }));
        }).observe(container);

        candleSeries = mainChart.addSeries(LightweightCharts.CandlestickSeries, {
            upColor: '#089981', downColor: '#f23645', borderVisible: false,
            wickUpColor: '#089981', wickDownColor: '#f23645',
            priceFormat: { type: 'price', precision: 6, minMove: 0.000001 },
        });
        
        volumeSeries = mainChart.addSeries(LightweightCharts.HistogramSeries, {
            color: '#26a69a', priceFormat: { type: 'volume' }, priceScaleId: '',
        });
        volumeSeries.priceScale().applyOptions({ scaleMargins: { top: 0.8, bottom: 0 } });

        mainChart.timeScale().applyOptions({
            shiftVisibleRangeOnNewBar: false,
        });

        const legend = document.getElementById('chart-legend');
        mainChart.subscribeCrosshairMove(param => {
            if (!param.time || !param.point || param.point.x < 0 || param.point.y < 0) {
                legend.style.display = 'none';
                return;
            }

            const data = param.seriesData.get(candleSeries);
            const volData = param.seriesData.get(volumeSeries);
            const masterPoint = masterData.find(d => d.time === param.time);
            if (!data || !masterPoint) return;

            legend.style.display = 'block';
            legend.style.left = (param.point.x + 165) + 'px';
            legend.style.top = (param.point.y + 65) + 'px';

            let html = `<div class="legend-ohlcv">`;
            html += `<div style="color: var(--text-gray); font-size: 10px; margin-bottom: 4px;">${formatUnixToLiteral(param.time)}</div>`;
            html += `O: ${data.open} H: ${data.high}<br>L: ${data.low} C: ${data.close}`;
            if (volData) html += `<br>Vol: ${volData.value.toLocaleString()}`;
            html += `</div>`;
            
            if (masterPoint.indicators) {
                Object.entries(masterPoint.indicators).forEach(([fullKey, val]) => {
                        const parts = fullKey.split('_');
                        const name = parts[0];
                        const suffix = parts[parts.length - 1];
                        
                        const params = parts.slice(1, -1).filter(p => !isNaN(p) && p !== "");
                        
                        const settings = params.length > 0 ? `(${params.join(',')})` : '';
                        const color = getSeriesColor(fullKey);

                        html += `<div class="legend-item">
                            <span>${name}${settings} ${suffix}</span>
                            <b style="color:${color}">${Number(val).toFixed(5)}</b>
                        </div>`;
                });
            }
            legend.innerHTML = html;
        });


        mainChart.timeScale().subscribeVisibleLogicalRangeChange(() => {
            if (isFetching || isReplaying || masterData.length === 0) return;
            const logicalRange = mainChart.timeScale().getVisibleLogicalRange();
            if (!logicalRange) return;

            syncBufferLimit();

            if (logicalRange.from < 10 && hasMoreHistory) {
                loadData('history', masterData[0].time * 1000);
            }
            if (logicalRange.to > masterData.length - 10) {
                loadData('future', (masterData[masterData.length - 1].time * 1000)+1);
            }
        });
        
        window.addEventListener('resize', syncBufferLimit);
        syncBufferLimit(); 

    }

    function syncBufferLimit() {
        const container = document.getElementById('main-chart-container');
        const spacing = mainChart.timeScale().options().barSpacing || 6;
        const visibleBars = Math.ceil(container.offsetWidth / spacing);
        const target = Math.max(3000, visibleBars * 3); 

        if (Math.abs(target - bufferLimit) > 200) {
            bufferLimit = target;
        }
    }

    function loadData(direction, referenceTs, limit = 1000) {
        if (isFetching && direction !== 'initial' && direction !== 'replay_init') return;
        
        const sym = document.getElementById('symbolSelect').value;
        const tf = document.getElementById('tfSelect').value;
        if(!sym || !tf) return;

        isFetching = true;
        requestDirection = direction;
        document.getElementById('loader').style.display = 'flex';
        
        const chainStr = chain.length ? `[${chain.map(i => `${i.name}(${i.params.join(',')})`).join(':')}]` : "";
        let url = `/ohlcv/1.1/select/${sym},${tf}${chainStr}`;
        
        const fetchLimit = (direction === 'replay_init') ? 1000 : Math.min(limit, 5000);
        let params = `output/JSONP?limit=${fetchLimit}&callback=__callbackData&subformat=3`;

        if (direction === 'replay_init') {
            url += `/after/${referenceTs}`;
            params += `&order=asc`; 
        } else if (direction === 'history') {
            url += `/until/${referenceTs || Date.now()}`;
            params += `&order=desc`;
        } else {
            const ts = referenceTs || (masterData.length > 0 ? masterData[masterData.length-1].time * 1000 : Date.now());
            url += (direction === 'future' || referenceTs) ? `/after/${ts}` : `/until/${Date.now()}`;
            params += (direction === 'future' || referenceTs) ? `&order=asc` : `&order=desc`;
        }

        const s = document.createElement('script');
        s.src = `${url}/${params}`;
        document.body.appendChild(s);
    }

    window.__callbackData = function(response) {
        isFetching = false;
        document.getElementById('loader').style.display = 'none';

        if (!response.result || response.result.time.length === 0) return;

        const res = response.result;
        const cols = response.columns;

        const incoming = res.time.map((t, i) => {
            const item = {
                time: t / 1000,
                open: res.open[i], high: res.high[i], low: res.low[i], close: res.close[i],
                value: res.volume[i], indicators: {}
            };
            cols.forEach((col, idx) => {
                if (idx > 5) item.indicators[col] = res[col][i];
            });
            return item;
        });

        if (requestDirection === 'replay_init') {
            const splitIndex = Math.min(incoming.length, 150);
            masterData = incoming.slice(0, splitIndex);
            replayFutureBuffer = incoming.slice(splitIndex);
            updateChartUI(cols);
            const timeScale = mainChart.timeScale();
            const visibleRange = timeScale.getVisibleLogicalRange();
            const barsInView = visibleRange.to - visibleRange.from;
            mainChart.timeScale().setVisibleLogicalRange({
                from: 0,
                to: barsInView
            });
            return; 
        }

        let combined = [...masterData, ...incoming];
        const uniqueMap = new Map();
        combined.forEach(d => uniqueMap.set(d.time, d));
        const newData = Array.from(uniqueMap.values()).sort((a, b) => a.time - b.time);
        
        const oldFirstTime = masterData[0]?.time;
        const addedToLeft = newData.findIndex(d => d.time === oldFirstTime);
        
        masterData = newData;

        if (masterData.length > bufferLimit) {
            if (requestDirection === 'history') {
                masterData = masterData.slice(0, bufferLimit); 
            } else {
                masterData = masterData.slice(-bufferLimit); 
            }
        }

        updateChartUI(cols);

        const timeScale = mainChart.timeScale();
        const logicalRange = timeScale.getVisibleLogicalRange();

        if (window.anchorTime) {
            const timeScale = mainChart.timeScale();
            const newLeftIndex = masterData.findIndex(d => d.time === window.anchorTime);
            if (newLeftIndex !== -1) {
                timeScale.setVisibleLogicalRange({
                    from: newLeftIndex,
                    to: newLeftIndex + (window.savedWidth || 50)
                });
            }
            window.anchorTime = null;
            window.savedWidth = null;
        }

        if (logicalRange !== null) {
            if (requestDirection === 'history' && addedToLeft > 0) {
                timeScale.setVisibleLogicalRange({ 
                    from: logicalRange.from + addedToLeft, 
                    to: logicalRange.to + addedToLeft 
                });
            } 
        }
    };

    function togglePlayback() {
        const btn = document.getElementById('btn-play-pause');
        if (replayTimer) {
            clearInterval(replayTimer);
            replayTimer = null;
            btn.innerHTML = "‚ñ∂ Play";
            btn.className = "replay-btn play";
        } else {
            if (replayFutureBuffer.length === 0) return alert("Replay Finished");
            btn.innerHTML = "‚è∏ Pause";
            btn.className = "replay-btn pause";
            replayTimer = setInterval(replayTick, replaySpeed);
        }
    }

    function changeReplaySpeed() {
        replaySpeed = parseInt(document.getElementById('replaySpeed').value);
        if (replayTimer) {
            clearInterval(replayTimer);
            replayTimer = setInterval(replayTick, replaySpeed);
        }
    }

    let isBufferingNext = false;

    function replayTick() {
        if (replayFutureBuffer.length === 0) {
            if (isBufferingNext) {
                return; 
            } else {
                togglePlayback();
                alert("End of available historical data.");
                return;
            }
        }

        if (replayFutureBuffer.length < 50 && !isBufferingNext) {
            fetchNextReplayBatch();
        }

        const nextCandle = replayFutureBuffer.shift();
        masterData.push(nextCandle);

        candleSeries.update(nextCandle);
        volumeSeries.update({
            time: nextCandle.time, value: nextCandle.value,
            color: nextCandle.close >= nextCandle.open ? 'rgba(38, 166, 154, 0.5)' : 'rgba(239, 83, 80, 0.5)'
        });

        if (nextCandle.indicators) {
            Object.entries(nextCandle.indicators).forEach(([key, val]) => {
                if(val === null) return;
                if (overlaySeriesMap[key]) overlaySeriesMap[key].update({ time: nextCandle.time, value: val });
                Object.values(panelCharts).forEach(p => {
                    if (p.series[key]) {
                        const extra = key.includes('hist') ? { color: val >= 0 ? '#26a69a' : '#ef5350' } : {};
                        p.series[key].update({ time: nextCandle.time, value: val, ...extra });
                    }
                });
            });
        }
    }

    function fetchNextReplayBatch() {
        isBufferingNext = true;
        
        const referenceBar = replayFutureBuffer.length > 0 
            ? replayFutureBuffer[replayFutureBuffer.length - 1] 
            : masterData[masterData.length - 1];
            
        const lastTs = referenceBar.time * 1000;
        const sym = document.getElementById('symbolSelect').value;
        const tf = document.getElementById('tfSelect').value;
        const chainStr = chain.length ? `[${chain.map(i => `${i.name}(${i.params.join(',')})`).join(':')}]` : "";

        let url = `/ohlcv/1.1/select/${sym},${tf}${chainStr}/after/${lastTs+1}`;
        let params = `output/JSONP?limit=1000&callback=__appendReplayData&subformat=3&order=asc`;

        const s = document.createElement('script');
        s.src = `${url}/${params}`;
        document.body.appendChild(s);
    }

    window.__appendReplayData = function(response) {
        isBufferingNext = false;
        
        if (!response.result || response.result.time.length === 0) {
            console.log("No more future data available to fetch.");
            return;
        }

        const res = response.result;
        const cols = response.columns;

        const incoming = res.time.map((t, i) => {
            const item = {
                time: t / 1000,
                open: res.open[i], high: res.high[i], low: res.low[i], close: res.close[i],
                value: res.volume[i], indicators: {}
            };
            cols.forEach((col, idx) => {
                if (idx > 5) item.indicators[col] = res[col][i];
            });
            return item;
        });

        replayFutureBuffer = [...replayFutureBuffer, ...incoming];
        console.log(`Replenished buffer with ${incoming.length} new bars.`);
    };

    function exitReplayMode(bResetAndLoad=true) {
        if (replayTimer) clearInterval(replayTimer);
        isReplaying = false;
        mainChart.applyOptions({
            timeScale: {
                shiftVisibleRangeOnNewBar: false,
            },
        });
        document.getElementById('replay-toolbar').style.display = 'none';
        if (bResetAndLoad ) resetAndLoad(false); 
    }

    function openCalendarModal() { document.getElementById('calendarModal').style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    
    function handleDateAction(action) {
        const val = document.getElementById('calendarInput').value;
        if (!val) return alert("Please select a date");
        
        closeModal('calendarModal');
        const [y, m, d] = val.split('-').map(Number);
        const ts = Date.UTC(y, m - 1, d);

        masterData = []; candleSeries.setData([]); volumeSeries.setData([]);
        Object.values(overlaySeriesMap).forEach(s => s.setData([]));
        Object.values(panelCharts).forEach(p => Object.values(p.series).forEach(s => s.setData([])));

        if (action === 'replay') {
            isReplaying = true;
            document.getElementById('replay-toolbar').style.display = 'flex';
            loadData('replay_init', ts); 
        } else {
            isReplaying = false;
            document.getElementById('replay-toolbar').style.display = 'none';
            loadData('future', ts, 1000); 
        }
    }

    function updateTimeframeOptions() {
        const sym = document.getElementById('symbolSelect').value;
        const tfSelect = document.getElementById('tfSelect');
        const availableTfs = symbolData[sym] || [];
        
        const currentTf = tfSelect.value;
        tfSelect.innerHTML = availableTfs.map(tf => `<option value="${tf}">${tf}</option>`).join('');
        
        if (availableTfs.includes(currentTf)) {
            tfSelect.value = currentTf;
        } else if (availableTfs.includes('1h')) {
            tfSelect.value = '1h';
        } else if (availableTfs.length > 0) {
            tfSelect.value = availableTfs[0];
        }
    }

    function openExportModal() {
        const modal = document.getElementById('export-modal');
        const dateInput = document.getElementById('export-after');
        if (masterData.length > 0) {
            dateInput.value = formatUnixToLiteral(masterData[0].time);
        } else {
            dateInput.value = formatUnixToLiteral(Math.floor(Date.now() / 1000));
        }
        modal.style.display = 'flex';
    }

    function runExport() {
        const sym = document.getElementById('symbolSelect').value;
        let tf = document.getElementById('tfSelect').value;
        
        if (document.getElementById('export-skiplast').checked) tf += ':skiplast';
        const output = document.getElementById('export-mt4').checked ? 'CSV/MT4' : 'CSV';
        
        const after = encodeURIComponent(document.getElementById('export-after').value);
        const limit = document.getElementById('export-limit').value;
        const order = document.getElementById('export-order').value;
        
        const chainStr = chain.length ? `[${chain.map(i => `${i.name}(${i.params.join(',')})`).join(':')}]` : "";
        const exportUrl = `/ohlcv/1.1/select/${sym},${tf}${chainStr}/after/${after}/output/${output}?limit=${limit}&order=${order}`;
        
        window.location.href = exportUrl;
        closeModal('export-modal');
    }

    function updateChartUI(cols = [], requestDirection) {

        candleSeries.setData(masterData.map(d => ({
            time: d.time, open: d.open, high: d.high, low: d.low, close: d.close
        })));
        
        volumeSeries.setData(masterData.map(d => ({
            time: d.time, value: d.value, 
            color: d.close >= d.open ? 'rgba(38, 166, 154, 0.5)' : 'rgba(239, 83, 80, 0.5)'
        })));

        const statusEl = document.querySelector('#status-indicator');
        if (statusEl) {
            statusEl.innerText = `Buffer: ${masterData.length} bars`;
        }

        cols.forEach((col, idx) => {
            if (idx <= 5) return; 

            const rawName = col.split('_')[0]; 
            const meta = indicatorMeta[rawName];
            if (!meta) return;

            const mainParts = col.split('__');
            const basePart = mainParts[0]; 
            const displayTitle = (mainParts.length > 1) 
                ? mainParts[1] 
                : basePart.split('_')[0];

            const targetPanel = (meta.meta && meta.meta.panel === 1) ? 1 : 0;

            if (targetPanel === 0) {
                if (!overlaySeriesMap[col]) {
                    overlaySeriesMap[col] = mainChart.addSeries(LightweightCharts.LineSeries, {
                        color: getSeriesColor(col),
                        lineWidth: 1,
                        title: displayTitle,
                        priceFormat: { type: 'price', precision: 6, minMove: 0.000001 },
                    });
                }
                overlaySeriesMap[col].setData(masterData.map(d => ({ 
                    time: d.time, value: d.indicators[col] 
                })).filter(v => v.value !== null));

            } else {
                const panelKey = basePart;
                if (!panelCharts[panelKey]) createPanel(panelKey);
                
                const pObj = panelCharts[panelKey];

                if (pObj.titleElement && !pObj.series[col]) {
                    pObj.titleElement.innerText = params.length > 0 ? `${nameOnly} (${params.join(',')})` : nameOnly;
                }

                if (!pObj.series[col]) {
                    pObj.series[col] = pObj.chart.addSeries(
                        col.includes('hist') ? LightweightCharts.HistogramSeries : LightweightCharts.LineSeries, 
                        {
                            color: getSeriesColor(col),
                            title: displayTitle,
                            lineWidth: 1,
                            priceFormat: { type: 'price', precision: 6, minMove: 0.000001 }
                        }
                    );
                }

                const seriesData = masterData.map(d => {
                    const item = { time: d.time, value: d.indicators[col] };
                    if (col.includes('hist')) {
                        item.color = d.indicators[col] >= 0 ? 'rgba(38, 166, 154, 0.5)' : 'rgba(239, 83, 80, 0.5)';
                    }
                    return item;
                }).filter(v => v.value !== null);

                pObj.series[col].setData(seriesData);
            }
        });
    }

    function createPanel(id) {
        const container = document.getElementById('panel-container');
        const div = document.createElement('div');
        div.className = 'indicator-panel';
        div.style.height = '130px';
        div.style.width = '100%';
        div.style.marginTop = '5px';

        const titleDiv = document.createElement('div');
        titleDiv.className = 'panel-title';
        titleDiv.id = `title-${id}`;
        titleDiv.innerText = getTitleString(id.toUpperCase());
        div.appendChild(titleDiv);

        container.appendChild(div);
        
        const panelColors = isDark ? 
            { back: '#131722', text: '#d1d4dc', grid: '#2a2e39' } : 
            { back: '#ffffff', text: '#131722', grid: '#f0f3fa' };

        const chart = LightweightCharts.createChart(div, {
            width: div.clientWidth, height: 130,
            layout: { 
                background: { color: panelColors.back }, 
                textColor: panelColors.text, 
                attributionLogo: false 
            },
            grid: {
                vertLines: { color: panelColors.grid },
                horzLines: { color: panelColors.grid },
            },
            timeScale: { 
                visible: false,
                shiftVisibleRangeOnNewBar: false
            },
            rightPriceScale: { borderVisible: false, minimumWidth: rightPriceScaleWidth },
        });
        
        panelCharts[id] = { chart, series: {} };
        
        panelCharts[id] = { chart, series: {} };
        const currentRange = mainChart.timeScale().getVisibleLogicalRange();
        if (currentRange) {
            chart.timeScale().setVisibleLogicalRange(currentRange);
        }
        mainChart.timeScale().subscribeVisibleLogicalRangeChange(range => {
            if (range) {
                chart.timeScale().setVisibleLogicalRange(range);
            }
        });
    }

    function getSeriesColor(col) {
        const palette = {
            'stoch_k': '#2962FF',  // Blue
            'stoch_d': '#FF6D00',  // Orange
            'signal': '#FF5252',   // Red
            'macd': '#2962FF',     // Blue
            'upper': '#787b86',    // Gray
            'lower': '#787b86',    // Gray
            'middle': '#FF9800',   // Amber
            'rsi': '#9c27b0',      // Purple
            'hist': '#26a69a'      // Teal
        };
        const mainParts = col.split('__');
        const suffix = (mainParts.length > 1 ? mainParts[1] : col.split('_').shift()).toLowerCase();
        color = 0;
        if (palette[suffix]) { 
            color = palette[suffix];
        } else {
            let hash = 0;
            for (let i = 0; i < col.length; i++) {
                hash = col.charCodeAt(i) + ((hash << 5) - hash);
            }
            color = `hsl(${Math.abs(hash % 360)}, 80%, 50%)`;
        }
        return color;
    }


    function getTitleString(col) {
        const parts = col.split('_');
        const name = parts[0].toUpperCase();
        const params = parts.filter(p => !isNaN(p) && p !== "");
        const titleStr = params.length > 0 ? `${name} (${params.join(',')})` : name;
        return titleStr;
    }


    function formatUnixToLiteral(ts) { return new Date(ts * 1000).toISOString().replace('T', ' ').slice(0, 19); }

    document.addEventListener('DOMContentLoaded', () => {
        initCharts();
        const s1 = document.createElement('script'); s1.src = "/ohlcv/1.1/list/symbols/output/JSONP?callback=__callbackList"; document.body.appendChild(s1);
        const s2 = document.createElement('script'); s2.src = "/ohlcv/1.1/list/indicators/output/JSONP?callback=__bp_callback"; document.body.appendChild(s2);
        
        document.getElementById('themeToggle').onclick = () => {
            isDark = !isDark;
            document.body.classList.toggle('dark-theme', isDark);
            const themeColors = isDark ? { back: '#131722', text: '#d1d4dc', grid: '#2a2e39' } : { back: '#ffffff', text: '#131722', grid: '#f0f3fa' };
            
            [mainChart, ...Object.values(panelCharts).map(p=>p.chart)].forEach(c => {
                c.applyOptions({
                    layout: { background: { color: themeColors.back }, textColor: themeColors.text },
                    grid: { vertLines: { color: themeColors.grid }, horzLines: { color: themeColors.grid } }
                });
            });
        };
    });
    
    window.__callbackList = (res) => {
        symbolData = res.result;
        const sel = document.getElementById('symbolSelect');
        sel.innerHTML = Object.keys(symbolData).sort().map(s => `<option value="${s}">${s}</option>`).join('');
        
        updateTimeframeOptions();
        
        resetAndLoad(true);
    };
    window.__bp_callback = (res) => {
        if(res.result) { indicatorMeta = res.result; document.getElementById('indicatorSelect').innerHTML = Object.keys(indicatorMeta).map(i => `<option value="${i}">${i.toUpperCase()}</option>`).join(''); }
    };


    function renderParams() {
        const indKey = document.getElementById('indicatorSelect').value;
        const meta = indicatorMeta[indKey];
        const container = document.getElementById('params');
        container.innerHTML = (meta && meta.defaults) ? 
            Object.keys(meta.defaults).map(k => `<div style="margin-bottom:5px"><label style="font-size:9px;display:block;">${k}</label><input type="text" id="p_${k}" value="${meta.defaults[k]}" style="width:100%;box-sizing:border-box;"></div>`).join('') :
            '<span style="color:#999; font-size:11px">No parameters</span>';
    }

    function addToChain() {
        if (isReplaying) {
            const confirmExit = confirm("Adding an indicator will exit Replay Mode and reload the chart. Do you want to continue?");
            if (!confirmExit) return;
        
            exitReplayMode(false);
        }
        const indKey = document.getElementById('indicatorSelect').value;
        const meta = indicatorMeta[indKey];
        if (!meta) return;
        const params = meta.defaults ? Object.keys(meta.defaults).map(k => document.getElementById(`p_${k}`).value) : [];
        
        chain.push({ name: indKey, params, meta });
        updateChainUI();

        const timeScale = mainChart.timeScale();
        const visibleRange = timeScale.getVisibleLogicalRange();
        
        let referenceTime = Date.now();
        let visibleBarCount = 1000;

        if (visibleRange !== null && masterData.length > 0) {
            visibleBarCount = Math.ceil(visibleRange.to - visibleRange.from) + 10;
            const firstVisibleIdx = Math.max(0, Math.floor(visibleRange.from));
            if (masterData[firstVisibleIdx]) {
                referenceTime = masterData[firstVisibleIdx].time * 1000;
            } else {
                referenceTime = masterData[0].time * 1000;
            }
        }

        Object.values(overlaySeriesMap).forEach(s => mainChart.removeSeries(s));
        overlaySeriesMap = {};
        masterData = []; 
        loadData('initial', referenceTime, visibleBarCount); 
    }

    function updateChainUI() {
        document.getElementById('chain-list').innerHTML = chain.map((item, idx) => `
            <div class="indicator-tag">${item.name}(${item.params.join(',')})
                <span style="cursor:pointer; margin-left:8px; font-weight:bold;" onclick="removeFromChain(${idx})">‚úï</span>
            </div>`).join('');
    }

    function removeFromChain(idx) {
        chain.splice(idx, 1);
        updateChainUI();
        resetAndLoad(true);
    }

</script>
</body>
</html>
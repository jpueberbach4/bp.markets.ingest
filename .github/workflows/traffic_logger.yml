name: "Daily Traffic Logger"

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-stats:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.TRAFFIC_ACTION_TOKEN }}

      - name: Fetch Traffic Data
        uses: sangonzal/repository-traffic-action@v.0.1.6
        env:
          TRAFFIC_ACTION_TOKEN: ${{ secrets.TRAFFIC_ACTION_TOKEN }}

      - name: Merge and Move Stats
        run: |
          mkdir -p .github/traffic
          python3 -c "import csv, os; def m(n): np=f'traffic/{n}.csv'; op=f'.github/traffic/{n}.csv'; (not os.path.exists(np) and None) or (d:={}) or (os.path.exists(op) and [d.update({r['date']:r}) for r in csv.DictReader(open(op))]) or [d.update({r['date']:r}) for r in csv.DictReader(open(np)) or []]; sd=sorted(d.keys()); f=open(op,'w',newline=''); w=csv.DictWriter(f,fieldnames=['date','count','uniques']); w.writeheader(); [w.writerow(d[x]) for x in sd]; f.close()
          m('clones'); m('views')"
          sudo rm -rf traffic

      - name: Commit and Push
        uses: Endbug/add-and-commit@v9
        with:
          author_name: "GitHub Action"
          author_email: "action@github.com"
          message: "Update stats [skip ci]"
          add: ".github/traffic/*"
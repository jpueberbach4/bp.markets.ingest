name: "Daily Traffic Logger"

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-stats:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.TRAFFIC_ACTION_TOKEN }}

      - name: Fetch Traffic Data
        uses: sangonzal/repository-traffic-action@v.0.1.6
        env:
          TRAFFIC_ACTION_TOKEN: ${{ secrets.TRAFFIC_ACTION_TOKEN }}

      - name: Merge and Move Stats
        run: |
          mkdir -p .github/traffic
          python3 -c "
import csv
import os
def merge(name):
    new_p = f'traffic/{name}.csv'
    old_p = f'.github/traffic/{name}.csv'
    if not os.path.exists(new_p): return
    data = {}
    if os.path.exists(old_p):
        with open(old_p, 'r', newline='') as f:
            reader = csv.DictReader(f)
            for row in reader: data[row['date']] = row
    with open(new_p, 'r', newline='') as f:
        reader = csv.DictReader(f)
        for row in reader: data[row['date']] = row
    sorted_d = sorted(data.keys())
    with open(old_p, 'w', newline='') as f:
        writer = csv.DictWriter(f, fieldnames=reader.fieldnames)
        writer.writeheader()
        for d in sorted_d: writer.writerow(data[d])
merge('clones')
merge('views')
"
          sudo rm -rf traffic

      - name: Commit and Push
        uses: Endbug/add-and-commit@v9
        with:
          author_name: "GitHub Action"
          author_email: "action@github.com"
          message: "Update stats [skip ci]"
          add: ".github/traffic/*"